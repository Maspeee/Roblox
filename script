local Players = game:GetService("Players")
local Teleport = game:GetService("TeleportService")
local RStorage = game:GetService("ReplicatedStorage")
local Http = game:GetService("HttpService")
local Core = game:GetService("CoreGui")

local team = "Marines"
local maxPing = 500

local plr = Players.LocalPlayer
local char, nextCursor

local placeId = 7449423635 --sea 3
local jobId = game.JobId
local api = "https://games.roblox.com/v1/games/" ..tostring(placeId) .."/servers/Public?sortOrder=Desc&limit=100"

function getDist(p1, p2)
    return (p1.Position -p2.Position).Magnitude
end

function findNearest()
	local nearest

	for _, v in workspace:GetChildren() do 
		if v.Name == "Chest3" or v.Name == "Chest2" then
			if not nearest then
				nearest = v

			elseif getDist(char.Head, v) < getDist(char.Head, nearest) then
				nearest = v
			end
		end
	end

    return nearest
end

function listServers(cursor)
	local success, ret
	cursor = (cursor and "&cursor=" ..cursor) or ""

	repeat
		success, ret = pcall(Http.JSONDecode, Http, game:HttpGet(api ..cursor))
		task.wait()
	until success and ret
	
	return ret
end

function serverHop()
	local success
	
	repeat
	   	local servers = listServers(nextCursor)

		for _, s in servers.data do
			if s.playing < s.maxPlayers and s.id ~= jobId and s.ping < maxPing then
				queue_on_teleport(game:HttpGet("https://raw.githubusercontent.com/Maspeee/GetChests/main/script"))
				success = pcall(Teleport.TeleportToPlaceInstance, Teleport, placeId, s.id)

				if success then break end
			end
		end
	   	
	   	nextCursor = servers.nextPageCursor
		task.wait()
	until success or not nextCursor
end

function onKick(child)
	if child.Name == "ErrorPrompt" then
		queue_on_teleport(game:HttpGet("https://raw.githubusercontent.com/Maspeee/GetChests/main/script"))
		Teleport:TeleportToPlaceInstance(placeId, jobId)
	end
end

--	Main	-------------------------------------

RStorage:WaitForChild("Remotes").CommF_:InvokeServer("SetTeam", team)
Core.RobloxPromptGui.promptOverlay.ChildAdded:Connect(onKick)
char = plr.Character or plr.CharacterAdded:Wait()

while true do
	local chest = findNearest()
	
	if not chest then break end
	if not char.Parent then break end
	
	char.PrimaryPart.CFrame = chest.CFrame
	task.wait(.1)
end

if char.Parent then
	serverHop()
end
